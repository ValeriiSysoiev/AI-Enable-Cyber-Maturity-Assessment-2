+ set -euo pipefail
+ SUBSCRIPTION=10233675-d493-4a97-9c81-4001e353a7bb
+ RG=rg-aaa-demo
+ REGION=canadacentral
+ ADMIN_EMAIL=va.sysoiev@audit3a.com
+ ACA_API=api-aaa-demo
+ ACA_WEB=web-aaa-demo
+ RED='\033[0;31m'
+ GREEN='\033[0;32m'
+ YELLOW='\033[1;33m'
+ NC='\033[0m'
+ echo -e '\033[1;33m==> Setting up Azure Monitor Alerts\033[0m'
[1;33m==> Setting up Azure Monitor Alerts[0m
++ az monitor log-analytics workspace list --resource-group rg-aaa-demo --query '[0].id' -o tsv
+ LAW_ID=/subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f
+ '[' -z /subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f ']'
+ echo -e '\033[0;32mâœ“ Found Log Analytics workspace: /subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f\033[0m'
[0;32mâœ“ Found Log Analytics workspace: /subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f[0m
+ ACTION_GROUP_NAME=ag-aaa-demo-alerts
+ echo 'Creating/updating Action Group...'
Creating/updating Action Group...
++ az monitor action-group create --name ag-aaa-demo-alerts --resource-group rg-aaa-demo --short-name AAA-Alerts --action email admin va.sysoiev@audit3a.com --query id -o tsv
+ ACTION_GROUP_ID=/subscriptions/10233675-D493-4A97-9C81-4001E353A7BB/resourceGroups/rg-aaa-demo/providers/microsoft.insights/actionGroups/ag-aaa-demo-alerts
+ echo -e '\033[0;32mâœ“ Action Group created/updated: /subscriptions/10233675-D493-4A97-9C81-4001E353A7BB/resourceGroups/rg-aaa-demo/providers/microsoft.insights/actionGroups/ag-aaa-demo-alerts\033[0m'
[0;32mâœ“ Action Group created/updated: /subscriptions/10233675-D493-4A97-9C81-4001E353A7BB/resourceGroups/rg-aaa-demo/providers/microsoft.insights/actionGroups/ag-aaa-demo-alerts[0m
+ echo 'Creating alert: High 5xx errors...'
Creating alert: High 5xx errors...
+ az monitor scheduled-query create --name High-5xx-Errors-API --resource-group rg-aaa-demo --scopes /subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f --condition 'count '\''avg'\'' > 20' --condition-query 'ContainerAppConsoleLogs_CL 
| where ContainerName_s == '\''api-aaa-demo'\'' 
| where TimeGenerated > ago(10m)
| where Log_s contains '\''"status":5'\'' or Log_s contains '\''"status_code":5'\''
| summarize count() by bin(TimeGenerated, 1m)' --description 'API returning high number of 5xx errors' --evaluation-frequency PT5M --window-size PT10M --severity 2 --action-groups /subscriptions/10233675-D493-4A97-9C81-4001E353A7BB/resourceGroups/rg-aaa-demo/providers/microsoft.insights/actionGroups/ag-aaa-demo-alerts --auto-mitigate true --enabled true --output none
/Users/valsysoiev/.azure/cliextensions/scheduled-query/azext_scheduled_query/vendored_sdks/__init__.py:6: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  __import__('pkg_resources').declare_namespace(__name__)
ERROR: unrecognized arguments: --enabled true

Examples from AI knowledge base:
https://aka.ms/cli_ref
Read more about the command in reference docs
+ echo 'Alert may already exist'
Alert may already exist
+ echo 'Creating alert: Container restart loops...'
Creating alert: Container restart loops...
+ az monitor scheduled-query create --name Container-Restart-Loops --resource-group rg-aaa-demo --scopes /subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f --condition 'count '\''avg'\'' > 3' --condition-query 'ContainerAppConsoleLogs_CL 
| where ContainerName_s in ('\''api-aaa-demo'\'', '\''web-aaa-demo'\'')
| where TimeGenerated > ago(10m)
| where Log_s contains '\''restart'\'' or Log_s contains '\''crash'\'' or Log_s contains '\''exit'\''
| summarize count() by ContainerName_s, bin(TimeGenerated, 1m)' --description 'Container experiencing frequent restarts' --evaluation-frequency PT5M --window-size PT10M --severity 1 --action-groups /subscriptions/10233675-D493-4A97-9C81-4001E353A7BB/resourceGroups/rg-aaa-demo/providers/microsoft.insights/actionGroups/ag-aaa-demo-alerts --auto-mitigate true --enabled true --output none
/Users/valsysoiev/.azure/cliextensions/scheduled-query/azext_scheduled_query/vendored_sdks/__init__.py:6: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  __import__('pkg_resources').declare_namespace(__name__)
ERROR: The command failed with an unexpected error. Here is the traceback:
ERROR: not enough values to unpack (expected 2, got 1)
Traceback (most recent call last):
  File "/Users/valsysoiev/.homebrew/Cellar/azure-cli/2.76.0/libexec/lib/python3.12/site-packages/knack/cli.py", line 233, in invoke
    cmd_result = self.invocation.execute(args)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/azure-cli/2.76.0/libexec/lib/python3.12/site-packages/azure/cli/core/commands/__init__.py", line 591, in execute
    parsed_args = self.parser.parse_args(args)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/azure-cli/2.76.0/libexec/lib/python3.12/site-packages/knack/parser.py", line 261, in parse_args
    return super().parse_args(args)
           ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1904, in parse_args
    args, argv = self.parse_known_args(args, namespace)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/azure-cli/2.76.0/libexec/lib/python3.12/site-packages/azure/cli/core/parser.py", line 281, in parse_known_args
    self._namespace, self._raw_arguments = super().parse_known_args(args=args, namespace=namespace)
                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1914, in parse_known_args
    return self._parse_known_args2(args, namespace, intermixed=False)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1943, in _parse_known_args2
    namespace, args = self._parse_known_args(args, namespace, intermixed)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2165, in _parse_known_args
    positionals_end_index = consume_positionals(start_index)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2141, in consume_positionals
    take_action(action, args)
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2018, in take_action
    action(self, namespace, argument_values, option_string)
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1272, in __call__
    subnamespace, arg_strings = parser.parse_known_args(arg_strings, None)
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/azure-cli/2.76.0/libexec/lib/python3.12/site-packages/azure/cli/core/parser.py", line 281, in parse_known_args
    self._namespace, self._raw_arguments = super().parse_known_args(args=args, namespace=namespace)
                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1914, in parse_known_args
    return self._parse_known_args2(args, namespace, intermixed=False)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1943, in _parse_known_args2
    namespace, args = self._parse_known_args(args, namespace, intermixed)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2165, in _parse_known_args
    positionals_end_index = consume_positionals(start_index)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2141, in consume_positionals
    take_action(action, args)
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2018, in take_action
    action(self, namespace, argument_values, option_string)
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1272, in __call__
    subnamespace, arg_strings = parser.parse_known_args(arg_strings, None)
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/azure-cli/2.76.0/libexec/lib/python3.12/site-packages/azure/cli/core/parser.py", line 281, in parse_known_args
    self._namespace, self._raw_arguments = super().parse_known_args(args=args, namespace=namespace)
                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1914, in parse_known_args
    return self._parse_known_args2(args, namespace, intermixed=False)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1943, in _parse_known_args2
    namespace, args = self._parse_known_args(args, namespace, intermixed)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2165, in _parse_known_args
    positionals_end_index = consume_positionals(start_index)
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2141, in consume_positionals
    take_action(action, args)
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2018, in take_action
    action(self, namespace, argument_values, option_string)
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1272, in __call__
    subnamespace, arg_strings = parser.parse_known_args(arg_strings, None)
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/azure-cli/2.76.0/libexec/lib/python3.12/site-packages/azure/cli/core/parser.py", line 281, in parse_known_args
    self._namespace, self._raw_arguments = super().parse_known_args(args=args, namespace=namespace)
                                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1914, in parse_known_args
    return self._parse_known_args2(args, namespace, intermixed=False)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 1943, in _parse_known_args2
    namespace, args = self._parse_known_args(args, namespace, intermixed)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2184, in _parse_known_args
    start_index = consume_optional(start_index)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2113, in consume_optional
    take_action(action, args, option_string)
  File "/Users/valsysoiev/.homebrew/Cellar/python@3.12/3.12.11/Frameworks/Python.framework/Versions/3.12/lib/python3.12/argparse.py", line 2018, in take_action
    action(self, namespace, argument_values, option_string)
  File "/Users/valsysoiev/.azure/cliextensions/scheduled-query/azext_scheduled_query/_actions.py", line 54, in __call__
    k, v = x.split('=', 1)
    ^^^^
ValueError: not enough values to unpack (expected 2, got 1)
To check existing issues, please visit: https://github.com/Azure/azure-cli/issues
+ echo 'Alert may already exist'
Alert may already exist
+ echo 'Creating alert: High CPU usage...'
Creating alert: High CPU usage...
+ az monitor scheduled-query create --name High-CPU-Usage-API --resource-group rg-aaa-demo --scopes /subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f --condition 'count '\''avg'\'' > 80' --condition-query 'ContainerAppConsoleLogs_CL 
| where ContainerName_s == '\''api-aaa-demo'\''
| where TimeGenerated > ago(10m)
| where Log_s contains '\''cpu'\'' and Log_s contains '\''%'\''
| extend CpuUsage = todouble(extract(@'\''cpu[^0-9]*([0-9.]+)'\'', 1, Log_s))
| where CpuUsage > 80
| summarize avg(CpuUsage) by bin(TimeGenerated, 1m)' --description 'API container experiencing high CPU usage' --evaluation-frequency PT5M --window-size PT10M --severity 2 --action-groups /subscriptions/10233675-D493-4A97-9C81-4001E353A7BB/resourceGroups/rg-aaa-demo/providers/microsoft.insights/actionGroups/ag-aaa-demo-alerts --auto-mitigate true --enabled true --output none
/Users/valsysoiev/.azure/cliextensions/scheduled-query/azext_scheduled_query/vendored_sdks/__init__.py:6: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  __import__('pkg_resources').declare_namespace(__name__)
ERROR: unrecognized arguments: --enabled true

Examples from AI knowledge base:
https://aka.ms/cli_ref
Read more about the command in reference docs
+ echo 'Alert may already exist'
Alert may already exist
+ echo 'Creating alert: Cosmos DB throttling...'
Creating alert: Cosmos DB throttling...
+ az monitor scheduled-query create --name Cosmos-DB-Throttling --resource-group rg-aaa-demo --scopes /subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f --condition 'count '\''avg'\'' > 0' --condition-query 'ContainerAppConsoleLogs_CL 
| where ContainerName_s == '\''api-aaa-demo'\''
| where TimeGenerated > ago(10m)
| where Log_s contains '\''429'\'' or Log_s contains '\''throttl'\'' or Log_s contains '\''rate limit'\''
| summarize count() by bin(TimeGenerated, 1m)' --description 'Cosmos DB requests being throttled (429 errors)' --evaluation-frequency PT5M --window-size PT10M --severity 2 --action-groups /subscriptions/10233675-D493-4A97-9C81-4001E353A7BB/resourceGroups/rg-aaa-demo/providers/microsoft.insights/actionGroups/ag-aaa-demo-alerts --auto-mitigate true --enabled true --output none
/Users/valsysoiev/.azure/cliextensions/scheduled-query/azext_scheduled_query/vendored_sdks/__init__.py:6: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  __import__('pkg_resources').declare_namespace(__name__)
ERROR: unrecognized arguments: --enabled true

Examples from AI knowledge base:
https://aka.ms/cli_ref
Read more about the command in reference docs
+ echo 'Alert may already exist'
Alert may already exist
+ echo -e '\033[1;33m==> Getting alert rule IDs...\033[0m'
[1;33m==> Getting alert rule IDs...[0m
++ az monitor scheduled-query list --resource-group rg-aaa-demo --query '[].{name:name,id:id}' -o table
/Users/valsysoiev/.azure/cliextensions/scheduled-query/azext_scheduled_query/vendored_sdks/__init__.py:6: UserWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html. The pkg_resources package is slated for removal as early as 2025-11-30. Refrain from using this package or pin to Setuptools<81.
  __import__('pkg_resources').declare_namespace(__name__)
+ ALERT_RULES=
+ echo -e '\033[0;32mâœ“ Alert rules configured:\033[0m'
[0;32mâœ“ Alert rules configured:[0m
+ echo ''

+ echo ''

+ echo -e '\033[0;32mâœ“ Azure Monitor alerts setup complete\033[0m'
[0;32mâœ“ Azure Monitor alerts setup complete[0m
+ echo 'Action Group ID: /subscriptions/10233675-D493-4A97-9C81-4001E353A7BB/resourceGroups/rg-aaa-demo/providers/microsoft.insights/actionGroups/ag-aaa-demo-alerts'
Action Group ID: /subscriptions/10233675-D493-4A97-9C81-4001E353A7BB/resourceGroups/rg-aaa-demo/providers/microsoft.insights/actionGroups/ag-aaa-demo-alerts
+ echo 'Log Analytics Workspace: /subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f'
Log Analytics Workspace: /subscriptions/10233675-d493-4a97-9c81-4001e353a7bb/resourceGroups/rg-aaa-demo/providers/Microsoft.OperationalInsights/workspaces/log-aaademo-lna70f
+ echo ''

+ echo 'KQL queries saved for reference:'
KQL queries saved for reference:
+ echo '- High 5xx: ContainerAppConsoleLogs_CL | where ContainerName_s == '\''api-aaa-demo'\'' | where Log_s contains '\''"status":5'\'''
- High 5xx: ContainerAppConsoleLogs_CL | where ContainerName_s == 'api-aaa-demo' | where Log_s contains '"status":5'
+ echo '- Restarts: ContainerAppConsoleLogs_CL | where Log_s contains '\''restart'\'''
- Restarts: ContainerAppConsoleLogs_CL | where Log_s contains 'restart'
+ echo '- CPU: ContainerAppConsoleLogs_CL | where Log_s contains '\''cpu'\'''
- CPU: ContainerAppConsoleLogs_CL | where Log_s contains 'cpu'
+ echo '- Throttling: ContainerAppConsoleLogs_CL | where Log_s contains '\''429'\'''
- Throttling: ContainerAppConsoleLogs_CL | where Log_s contains '429'
