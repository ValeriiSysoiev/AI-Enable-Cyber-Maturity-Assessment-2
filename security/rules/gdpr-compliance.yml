rules:
  - id: gdpr-personal-data-without-consent
    pattern-either:
      - pattern: |
          def $FUNC(...):
              ...
              user_data = {..., "email": ..., ...}
              ...
      - pattern: |
          def $FUNC(...):
              ...
              user_data = {..., "phone": ..., ...}
              ...
      - pattern: |
          def $FUNC(...):
              ...
              user_data = {..., "address": ..., ...}
              ...
    pattern-not-inside:
      - pattern: |
          def $FUNC(...):
              ...
              if consent_given:
                  ...
      - pattern: |
          def $FUNC(...):
              ...
              if user.consent:
                  ...
    paths:
      include:
        - "app/**/*.py"
        - "web/**/*.ts"
        - "web/**/*.tsx"
    message: Personal data collection without explicit consent check
    languages: [python, typescript, javascript]
    severity: ERROR
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 6"
      
  - id: gdpr-missing-data-retention-policy
    pattern-either:
      - pattern: |
          class $MODEL(...):
              ...
              email = ...
              ...
      - pattern: |
          class $MODEL(...):
              ...
              personal_data = ...
              ...
    pattern-not-inside:
      - pattern: |
          class $MODEL(...):
              ...
              created_at = ...
              retention_period = ...
              ...
      - pattern: |
          class $MODEL(...):
              ...
              expires_at = ...
              ...
    paths:
      include:
        - "app/domain/models.py"
    message: Model with personal data missing retention policy
    languages: [python]
    severity: WARNING
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 5(1)(e)"

  - id: gdpr-data-export-missing
    pattern-either:
      - pattern: |
          def delete_user($USER_ID):
              ...
      - pattern: |
          def remove_user($USER_ID):
              ...
    pattern-not-inside:
      - pattern: |
          def export_user_data($USER_ID):
              ...
    message: User deletion without data export capability (right to portability)
    languages: [python]
    severity: ERROR
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 20"

  - id: gdpr-logging-personal-data
    pattern-either:
      - pattern: |
          logger.$METHOD(..., email=..., ...)
      - pattern: |
          logger.$METHOD(..., user_id=..., ...)
      - pattern: |
          logger.$METHOD(..., personal_info=..., ...)
      - pattern: |
          print(..., email, ...)
      - pattern: |
          console.log(..., email, ...)
      - pattern: |
          console.log(..., userData, ...)
    message: Logging personal data may violate GDPR data minimization
    languages: [python, typescript, javascript]
    severity: WARNING
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 5(1)(c)"

  - id: gdpr-data-transfer-without-safeguards
    pattern-either:
      - pattern: |
          requests.post("http://api.example.com", data={..., "email": ..., ...})
      - pattern: |
          fetch("http://api.thirdparty.com", {
              method: "POST",
              body: JSON.stringify({..., email: ..., ...})
          })
    pattern-not-inside:
      - pattern: |
          if is_adequate_country($URL):
              ...
      - pattern: |
          if has_standard_contractual_clauses($URL):
              ...
    message: International data transfer without adequate safeguards
    languages: [python, typescript, javascript]
    severity: ERROR
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 44"

  - id: gdpr-missing-privacy-by-design
    pattern: |
      def create_user(...):
          user = User(
              email=$EMAIL,
              name=$NAME,
              ...
          )
          ...
    pattern-not-inside:
      - pattern: |
          def create_user(...):
              ...
              if not validate_consent($CONSENT):
                  raise Exception("Consent required")
              ...
      - pattern: |
          def create_user(...):
              ...
              user.data_processing_purpose = ...
              ...
    message: User creation without privacy-by-design principles
    languages: [python]
    severity: WARNING
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 25"

  - id: gdpr-weak-pseudonymization
    pattern-either:
      - pattern: |
          user_id = hash($EMAIL)
      - pattern: |
          anonymized_id = md5($EMAIL)
      - pattern: |
          pseudo_id = sha1($EMAIL)
    message: Weak pseudonymization technique - use cryptographically secure methods
    languages: [python, typescript, javascript]
    severity: WARNING
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 4(5)"

  - id: gdpr-data-breach-no-notification
    pattern: |
      except Exception as e:
          logger.error("Database error: %s", e)
          ...
    pattern-not-inside:
      - pattern: |
          except Exception as e:
              logger.error("Database error: %s", e)
              if is_personal_data_affected(e):
                  notify_data_protection_officer()
              ...
    paths:
      include:
        - "app/**/*.py"
    message: Exception handling missing data breach notification procedure
    languages: [python]
    severity: INFO
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 33"

  - id: gdpr-consent-not-withdrawable
    pattern: |
      def give_consent($USER_ID):
          ...
    pattern-not:
      - pattern: |
          def withdraw_consent($USER_ID):
              ...
    message: Consent mechanism without withdrawal capability
    languages: [python, typescript, javascript]
    severity: ERROR
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 7(3)"

  - id: gdpr-automated-decision-making
    pattern-either:
      - pattern: |
          def auto_approve($USER_DATA):
              if ml_model.predict($USER_DATA) > 0.8:
                  return approve()
              ...
      - pattern: |
          const decision = aiModel.predict(userData)
          if (decision.confidence > 0.8) {
              approveApplication()
          }
    pattern-not-inside:
      - pattern: |
          if user.consent_to_automated_processing:
              ...
      - pattern: |
          # Human review required for automated decisions
          ...
    message: Automated decision-making without user consent or human review
    languages: [python, typescript, javascript]
    severity: ERROR
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 22"

  - id: gdpr-data-minimization-violation
    pattern-either:
      - pattern: |
          SELECT * FROM users WHERE ...
      - pattern: |
          const userData = await User.findAll({
              attributes: ['*']
          })
    message: Data collection not limited to necessary fields (data minimization)
    languages: [python, typescript, javascript]
    severity: WARNING
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 5(1)(c)"

  - id: gdpr-missing-lawful-basis
    pattern: |
      def process_personal_data($DATA):
          ...
    pattern-not-inside:
      - pattern: |
          def process_personal_data($DATA, lawful_basis: str):
              ...
      - pattern: |
          # Lawful basis: legitimate interest
          def process_personal_data($DATA):
              ...
      - pattern: |
          # Lawful basis: consent
          def process_personal_data($DATA):
              ...
    message: Personal data processing without documented lawful basis
    languages: [python]
    severity: ERROR
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 6"

  - id: gdpr-cross-border-data-flow
    pattern-either:
      - pattern: |
          backup_server = "us-east-1.amazonaws.com"
      - pattern: |
          api_endpoint = "https://api.us.service.com"
      - pattern: |
          database_host = "db.asia.provider.com"
    message: Cross-border data flow requires GDPR compliance assessment
    languages: [python, typescript, javascript]
    severity: INFO
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Chapter V"

  - id: gdpr-insufficient-encryption
    pattern-either:
      - pattern: |
          def encrypt_personal_data($DATA):
              return base64.b64encode($DATA)
      - pattern: |
          encrypted = btoa(personalData)
    message: Insufficient encryption for personal data - use strong encryption
    languages: [python, typescript, javascript]
    severity: ERROR
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Article 32"

  - id: gdpr-data-subject-rights-missing
    pattern: |
      @app.route("/user/<user_id>", methods=["GET"])
      def get_user($USER_ID):
          ...
    pattern-not:
      - pattern: |
          @app.route("/user/<user_id>/export", methods=["GET"])
          def export_user_data($USER_ID):
              ...
    message: User endpoint missing data subject rights implementation
    languages: [python]
    severity: WARNING
    metadata:
      category: privacy
      subcategory: gdpr
      regulation: "GDPR Articles 15-22"