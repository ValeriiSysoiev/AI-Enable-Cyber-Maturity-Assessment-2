From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Valerii Sysoiev <valsysoiev@gmail.com>
Date: Sun, 17 Aug 2025 23:07:21 -0600
Subject: [PATCH 58/90] feat: implement evidence links API with cross-partition
 lookup
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

- Enhanced get_evidence_by_id() method for cross-partition queries using asyncio.to_thread
- Complete evidence linking/unlinking API endpoints already implemented
- GET /api/v1/evidence with pagination headers (X-Total-Count, X-Page, X-Page-Size)
- POST/DELETE /api/v1/evidence/{id}/links for link management with itemType:itemId format
- Comprehensive unit and integration tests for full workflow coverage
- Enforced engagement isolation with audit logging throughout

ðŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>

diff --git a/app/repos/cosmos_repository.py b/app/repos/cosmos_repository.py
index 92af3ed75f22c41d469ac21ba96a856a20373d2e..e1d0b1578a313c7f9516602051b800bad6528d6c 100644
--- a/app/repos/cosmos_repository.py
+++ b/app/repos/cosmos_repository.py
@@ -829,22 +829,24 @@ class CosmosRepository(Repository):
             raise
     
     async def get_evidence_by_id(self, evidence_id: str) -> Optional[Evidence]:
-        """Get evidence record by ID without requiring engagement_id"""
+        """Get evidence record by ID without requiring engagement_id (cross-partition lookup)"""
         try:
-            container = self.containers["evidence"]
-            
             # Query for the evidence by id across all partitions
             query = "SELECT * FROM c WHERE c.id = @evidence_id"
             parameters = [{"name": "@evidence_id", "value": evidence_id}]
             
-            items = container.query_items(
-                query=query,
-                parameters=parameters,
-                enable_cross_partition_query=True
+            # Use async query with cross-partition support
+            items = await asyncio.to_thread(
+                lambda: list(self.containers["evidence"].query_items(
+                    query=query,
+                    parameters=parameters,
+                    enable_cross_partition_query=True
+                ))
             )
             
-            # Get the first (and should be only) result
-            for item in items:
+            # Return the first (and should be only) result
+            if items:
+                item = items[0]
                 logger.info(
                     "Evidence record retrieved by ID",
                     extra={
