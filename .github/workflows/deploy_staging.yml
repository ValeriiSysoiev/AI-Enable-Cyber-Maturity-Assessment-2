name: Deploy Staging

on:
  workflow_dispatch:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build_and_push_ghcr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Enable GHCR (skip if disabled)
        run: |
          if [ "${GHCR_ENABLED:-1}" != "1" ]; then
            echo "::notice::GHCR disabled; skipping image build/push"
            exit 0
          fi
      
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build & push API image
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/aecma-api:${{ github.sha }} ./app
          docker push ghcr.io/${{ github.repository_owner }}/aecma-api:${{ github.sha }}
      
      - name: Build & push Web image
        run: |
          docker build -t ghcr.io/${{ github.repository_owner }}/aecma-web:${{ github.sha }} ./web
          docker push ghcr.io/${{ github.repository_owner }}/aecma-web:${{ github.sha }}

  deploy_azure_aca:
    needs: build_and_push_ghcr
    runs-on: ubuntu-latest
    if: ${{ env.AZURE_SUBSCRIPTION_ID != '' && env.AZURE_CLIENT_ID != '' && env.AZURE_TENANT_ID != '' && env.ACA_RG != '' && env.ACA_ENV != '' && env.ACA_APP_API != '' && env.ACA_APP_WEB != '' }}
    steps:
      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}
      
      - name: Deploy API Container App
        run: |
          az containerapp update \
            --name $ACA_APP_API --resource-group $ACA_RG --environment $ACA_ENV \
            --image ghcr.io/${{ github.repository_owner }}/aecma-api:${{ github.sha }} || true
      
      - name: Deploy Web Container App
        run: |
          az containerapp update \
            --name $ACA_APP_WEB --resource-group $ACA_RG --environment $ACA_ENV \
            --image ghcr.io/${{ github.repository_owner }}/aecma-web:${{ github.sha }} || true
      
      - name: Output staging URL
        id: url
        run: echo "STAGING_URL=https://$ACA_APP_WEB.$ACA_ENV.azurecontainerapps.io" >> $GITHUB_OUTPUT